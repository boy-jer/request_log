<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />

	<title>File: README.rdoc [RDoc Documentation]</title>

	<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet" />

	<script src="./js/jquery.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="./js/thickbox-compressed.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="./js/quicksearch.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="./js/darkfish.js" type="text/javascript"
		charset="utf-8"></script>
</head>

<body class="file">
	<div id="metadata">
		<div id="home-metadata">
			<div id="home-section" class="section">
        <h3 class="section-header">
          <a href="./index.html">Home</a>
          <a href="./index.html#classes">Classes</a>
          <a href="./index.html#methods">Methods</a>
        </h3>
			</div>
		</div>

		<div id="project-metadata">
			
			
			<div id="fileindex-section" class="section project-section">
				<h3 class="section-header">Files</h3>
				<ul>
				
					<li class="file"><a href="./README_rdoc.html">README.rdoc</a></li>
				
				</ul>
			</div>
			

			<div id="classindex-section" class="section project-section">
				<h3 class="section-header">Class Index
					<span class="search-toggle"><img src="./images/find.png"
						height="16" width="16" alt="[+]"
						title="show/hide quicksearch" /></span></h3>
				<form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
				<fieldset>
					<legend>Quicksearch</legend>
					<input type="text" name="quicksearch" value=""
						class="quicksearch-field" />
				</fieldset>
				</form>

				<ul class="link-list">
				
				</ul>
				<div id="no-class-search-results" style="display: none;">No matching classes.</div>
			</div>

			
		</div>
	</div>

	<div id="documentation">
		<h1>Request Log</h1>
<p>
Request Log is a Rack middleware for logging web requests to MongoDB. Each
web request becomes a document in MongoDB with fields like path, method,
params, status, time, ip, runtime etc. The gem offers support for
monitoring the time overhead (usually very small) that the logging incurs.
The advantages of logging to MongoDB over logging to a plain text file are
huge because of the query capabilities of MongoDB. Here is an example of
what a log document can look like:
</p>
<pre>
  method: &quot;GET&quot;
  path: &quot;/&quot;
  ip: &quot;10.218.1.177&quot;
  time: 2010-10-28 21:43:38 UTC
  params: {&quot;hello_world&quot;=&gt;&quot;1&quot;}
  status: 200
  runtime: 0.000303
</pre>
<p>
You can easily customize which fields are stored in the log.
</p>
<h2>Installation</h2>
<p>
Add gem dependencies with appropriate version numbers to your Gemfile
(assuming you use Bundler):
</p>
<pre>
  gem 'mongo', '~&gt; version known to work'
  gem 'bson_ext', '~&gt; version known to work'
  gem 'request_log', '~&gt; version known to work'
</pre>
<p>
Install with:
</p>
<pre>
  bundle install
</pre>
<p>
Note that it&#8217;s up to your application how it wants to connect to
MongoDB (if at all) and the suggested mongo and bson_ext gems are just
suggestions.
</p>
<p>
Next you need to setup a MongoDB connection. Here is a MongoHQ example that
in Rails would belong in config/initializers/request_log.rb:
</p>
<pre>
  if ENV['MONGOHQ_URL']
          require 'uri'
          require 'mongo'      
          uri = URI.parse(ENV['MONGOHQ_URL'])
          connection = Mongo::Connection.from_uri(uri.to_s)
          RequestLog::Db.mongo_db = connection.db(uri.path.gsub(/^\//, ''))
  end
</pre>
<p>
MongoDB recommends using capped collections for logging as they have good
write performance. Here is an example of how to do log rotation when the
size hits 20GB (this step is optional, note that the command may take a
while):
</p>
<pre>
  RequestLog::Db.mongo_db.create_collection(&quot;requests&quot;, :capped =&gt; true, :size =&gt; 20000000000)
</pre>
<p>
Now setup the Middleware in your config.ru file:
</p>
<pre>
  use RequestLog::Middleware
</pre>
<p>
Here is an example of how you can customize the middleware:
</p>
<pre>
  use RequestLog::Middleware,
          :logger =&gt; lambda { |data| ::RequestLog::Db.requests.insert(data.attributes.except(:runtime)) },
          :timeout =&gt; 0.5
</pre>
<p>
In order to use the Rake tasks you need to make sure you have the MongoDB
connection setup and that you require the tasks in your Rakefile, like
this:
</p>
<pre>
  require 'request_log'
  require 'config/initializers/request_log.rb' # The file where you setup the mongo db connection
  require 'request_log/tasks'
</pre>
<h2>Accessing the logs</h2>
<p>
You can tail the log like this:
</p>
<pre>
  rake request_log:tail
</pre>
<p>
If you want to query the log and print a certain time period you can use
request_log:print:
</p>
<pre>
  rake request_log:print from=&quot;2010-10-28 17:06:08&quot; to=&quot;2010-10-28 17:06:10&quot; conditions='status: 200'
</pre>
<p>
If you are using MONGOHQ, remember to set the MONGOHQ_URL environment
variable.
</p>
<h2>Profiling</h2>
<p>
To monitor the time consumption and reliability of the MongoDB logging you
can use the RequestLog::Profiler class. It records number of failed and
successful loggings, average and maximum logging times etc. To persist the
profiling information to MongoDB you can configure the profiler like this:
</p>
<pre>
  RequestLog::Profiler.persist_enabled = true
  RequestLog::Profiler.persist_frequency = 1000 # persist profiling info every 1000 requests
</pre>
<p>
The profiling info will then be written to a table (request_log_profiling)
in the MongoDB database.
</p>

	</div>

	<div id="validator-badges">
		<p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
		<p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
			Rdoc Generator</a> 1.1.6</small>.</p>
	</div>
</body>
</html>

